@page files Handling Files in MantisBase

MantisBase supports file uploads and management for database records. Files can be associated with records through `file` or `files` field types and are stored on disk with references in the database.

---

## File Serving

All files stored in the database are accessible via:

```
GET /api/files/<entity>/<filename>
```

- `<entity>`: The entity (table) name the file is associated with
- `<filename>`: The name of the file to retrieve

**Example:**

```bash
curl http://localhost:7070/api/files/posts/image123.jpg
```

The endpoint returns the file if it exists, or a 404 error if not found.

---

## Creating Records with Files

To create a record with file uploads, send a POST request using `multipart/form-data`:

**Endpoint:** `POST /api/v1/entities/<entity>`

**Example using curl:**

```bash
curl -X POST http://localhost:7070/api/v1/entities/posts \
  -H "Authorization: Bearer <token>" \
  -F "title=My Post" \
  -F "content=Post content" \
  -F "image=@/path/to/image.jpg"
```

**Example using JavaScript (FormData):**

```javascript
const formData = new FormData();
formData.append('title', 'My Post');
formData.append('content', 'Post content');
formData.append('image', fileInput.files[0]);

fetch('http://localhost:7070/api/v1/entities/posts', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token
  },
  body: formData
});
```

The backend processes and stores the files, associating them with the new record. File names are stored in the database record.

---

## Updating Files in Records

To update files associated with a record, send a PATCH request with `multipart/form-data`:

**Endpoint:** `PATCH /api/v1/entities/<entity>/<id>`

**Example:**

```bash
curl -X PATCH http://localhost:7070/api/v1/entities/posts/123 \
  -H "Authorization: Bearer <token>" \
  -F "title=Updated Title" \
  -F "image=@/path/to/new-image.jpg"
```

**Important:** For fields that accept multiple files (`files` type), include all files you want to keep. Any files not included in the update will be deleted from both the database record and the filesystem.

---

## Deleting Files

To delete a file from a record:

1. Send a PATCH request to update the record
2. Omit the file name from the relevant field, or set it to `null`

**Example:**

```bash
# Update record without the file field
curl -X PATCH http://localhost:7070/api/v1/entities/posts/123 \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"title": "Updated", "image": null}'
```

The backend detects the missing file and removes it from both the database and filesystem.

---

## File Storage

Files are stored in the data directory under:

```
<dataDir>/<entity>/<filename>
```

For example, if `dataDir` is `./data` and entity is `posts`, a file `image.jpg` would be stored at:

```
./data/posts/image.jpg
```

---

## Field Types

MantisBase supports two file field types:

- **`file`** - Single file field
- **`files`** - Multiple files field (stored as JSON array of filenames)

When defining your schema:

```json
{
  "name": "posts",
  "fields": [
    {"name": "title", "type": "string"},
    {"name": "image", "type": "file"},
    {"name": "attachments", "type": "files"}
  ]
}
```

---

## Notes

- Always use the correct entity name and field names as defined in your schema
- For `files` type fields, include all files you want to retain in update requests
- File operations are transactional with record creation/updates
- Files are automatically deleted when records are deleted
- File names are sanitized to ensure filesystem safety

---

## Summary

MantisBase provides straightforward file handling through multipart form data uploads. Files are stored on disk and referenced in database records, with automatic cleanup when records are updated or deleted.
