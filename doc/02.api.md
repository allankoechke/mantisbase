@page rest_api REST API Reference Guide

MantisBase provides auto-generated RESTful APIs for interacting with database entities. This document covers the entity endpoints, schema management, and request handling.

---

## üåê Base URL

When MantisBase is running locally:

```
http://localhost:7070/api/v1/
```

You can configure the port and host using command-line arguments:

```bash
mantisbase serve -p 8000 -h 127.0.0.1
```

---

## üìÑ Entity Endpoints

MantisBase automatically exposes CRUD endpoints for each entity (table or view):

| Method | Endpoint                              | Description           |
|--------|---------------------------------------|-----------------------|
| GET    | `/api/v1/entities/<entity>`           | List all records      |
| GET    | `/api/v1/entities/<entity>/:id`       | Get a specific record |
| POST   | `/api/v1/entities/<entity>`           | Create a new record   |
| PATCH  | `/api/v1/entities/<entity>/:id`       | Update partial fields |
| DELETE | `/api/v1/entities/<entity>/:id`       | Delete a record       |

### Example Requests

```bash
# List all users
curl http://localhost:7070/api/v1/entities/users

# Get specific user
curl http://localhost:7070/api/v1/entities/users/123

# Create a new user
curl -X POST http://localhost:7070/api/v1/entities/users \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "John Doe", "email": "john@example.com"}'

# Update user
curl -X PATCH http://localhost:7070/api/v1/entities/users/123 \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "Jane Doe"}'

# Delete user
curl -X DELETE http://localhost:7070/api/v1/entities/users/123 \
  -H "Authorization: Bearer <token>"
```

---

## üîê Authentication

All entity endpoints require authentication via JWT tokens. Include the token in the `Authorization` header:

```
Authorization: Bearer <token>
```

For authentication endpoints, see [Authentication API](02.auth.md).

---

## üõ°Ô∏è Middlewares

Middlewares are functions that run before your route handler, allowing you to add authentication, authorization, and request processing logic.

### Default Middlewares

Every endpoint automatically has two middlewares applied globally:

1. **`getAuthToken()`** - Extracts JWT token from `Authorization` header and stores it in request context
2. **`hydrateContextData()`** - Validates token, fetches user data from database, and populates request context with user information

Additionally, entity endpoints automatically have:
3. **`hasAccess(entity_name)`** - Evaluates entity access rules to determine if the authenticated user can perform the requested operation. Called automatically by entity endpoints to confirm access rules before data query.

### Available Middlewares

You can use these middlewares when creating custom endpoints:

| Middleware | Description | Usage |
|------------|-------------|-------|
| `getAuthToken()` | Extract token from Authorization header | Applied globally to all routes |
| `hydrateContextData()` | Validate token and load user data | Applied globally to all routes |
| `hasAccess(entity_name)` | Check entity access rules | Applied automatically to entity endpoints |
| `requireAdminAuth()` | Require admin authentication | Blocks non-admin users |
| `requireEntityAuth(entity_name)` | Require authentication from specific entity | Only allows users from specified entity table |
| `requireAdminOrEntityAuth(entity_name)` | Require admin OR entity auth | Allows admins or users from specified entity |
| `requireGuestOnly()` | Require no authentication | Blocks authenticated users, only allows guests |
| `requireExprEval(expr)` | Evaluate custom expression | Custom expression-based access control |

### Using Middlewares

When creating custom endpoints, you can specify middlewares as the third parameter:

```cpp
// Require admin authentication
router.Get("/api/v1/admin/stats", [](MantisRequest& req, MantisResponse& res) {
    res.sendJSON(200, {{"stats", "data"}});
}, {requireAdminAuth()});

// Require authentication from specific entity
router.Get("/api/v1/users/profile", [](MantisRequest& req, MantisResponse& res) {
    auto auth = req.getOr<json>("auth", json::object());
    std::string userId = auth["id"];
    // ... return user profile
}, {requireEntityAuth("users")});

// Allow admins OR users from specific entity
router.Get("/api/v1/posts/draft", [](MantisRequest& req, MantisResponse& res) {
    // ... return draft posts
}, {requireAdminOrEntityAuth("users")});

// Guest-only endpoint (no authentication required)
router.Get("/api/v1/public/info", [](MantisRequest& req, MantisResponse& res) {
    res.sendJSON(200, {{"info", "public data"}});
}, {requireGuestOnly()});

// Custom expression evaluation
router.Get("/api/v1/restricted", [](MantisRequest& req, MantisResponse& res) {
    // ... handler
}, {requireExprEval("auth.id != \"\" && auth.user.verified == true")});

// Multiple middlewares (executed in order)
router.Post("/api/v1/sensitive", [](MantisRequest& req, MantisResponse& res) {
    // ... handler
}, {
    requireAdminAuth(),
    requireExprEval("req.body.priority <= 5")
});
```

### Accessing User Data in Handlers

After middlewares run, you can access authenticated user data from the request context:

```cpp
router.Get("/api/v1/me", [](MantisRequest& req, MantisResponse& res) {
    // Get auth data from context (set by middlewares)
    auto auth = req.getOr<json>("auth", json::object());
    
    if (auth["type"] == "guest") {
        res.sendJSON(401, {{"error", "Not authenticated"}});
        return;
    }
    
    // Access user information
    std::string userId = auth["id"];
    std::string userEntity = auth["entity"];
    json userData = auth["user"]; // Full user record from database
    
    res.sendJSON(200, {{"user", userData}});
});
```

> **Note**: Middlewares execute in the order they are specified. If a middleware returns `HandlerResponse::Handled`, subsequent middlewares and the handler are skipped.

---

## üóÉÔ∏è Schema Management API

Schema management endpoints allow you to create, read, update, and delete entity schemas. **These endpoints require admin authentication only.**

| Method | Endpoint                              | Description              |
|--------|---------------------------------------|--------------------------|
| GET    | `/api/v1/schemas`                     | List all schemas         |
| GET    | `/api/v1/schemas/:schema_name_or_id`  | Get a specific schema     |
| POST   | `/api/v1/schemas`                     | Create a new schema      |
| PATCH  | `/api/v1/schemas/:schema_name_or_id` | Update a schema           |
| DELETE | `/api/v1/schemas/:schema_name_or_id` | Delete a schema           |

### Example: Create a Schema

```bash
curl -X POST http://localhost:7070/api/v1/schemas \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "posts",
    "type": "base",
    "fields": [
      {"name": "title", "type": "string", "required": true},
      {"name": "content", "type": "string"},
      {"name": "author_id", "type": "string", "required": true}
    ],
    "rules": {
      "list": {"mode": "public", "expr": "auth.id != \"\""},
      "get": {"mode": "auth", "expr": ""},
      "add": {"mode": "auth", "expr": ""},
      "update": {"mode": "auth", "expr": ""},
      "delete": {"mode": "custom", "expr": "auth.entity == \"mb_admins\""}
    }
  }'
```

> ‚ö†Ô∏è **Admin Only**: All schema endpoints require admin authentication. Regular users cannot access these endpoints.

---

## üéõÔ∏è Query Parameters [PENDING]

Future support for filtering, sorting, and pagination:

```
GET /api/v1/entities/tasks?status=done&limit=10&offset=20&sort=-created_at
```

---

## ‚öôÔ∏è Custom Endpoints

You can create custom API endpoints using the router:

```cpp
router.Get("/api/v1/custom", [](MantisRequest& req, MantisResponse& res) {
    res.sendJSON(200, {{"message", "Custom endpoint"}});
}, {requireAdminAuth()});
```

Check the [Embedding Guide](05.embedding.md) for more details.

---

## üìÅ File Handling

Files uploaded via multipart/form-data are stored and can be accessed at:

```
GET /api/files/<entity>/<filename>
```

See [File Handling](11.files.md) for more details.

---

## üèÅ Summary

MantisBase provides zero-setup REST APIs for all your entities. With automatic authentication, access control, and schema management, it's ready to use out of the box.
